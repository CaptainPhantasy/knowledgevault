<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="KnowledgeVault - Open-source knowledge preservation platform">
    <meta name="theme-color" content="#1a1a1a">
    <title>KnowledgeVault</title>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/x-icon" href="assets/icons/favicon.ico">
    <link rel="apple-touch-icon" href="assets/icons/apple-touch-icon.png">
    
    <!-- Styles -->
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="css/print.css" media="print">
    
    <!-- Leaflet for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-spinner"></div>
        <p>Initializing KnowledgeVault...</p>
    </div>

    <!-- App Container -->
    <div id="app" class="app-container" style="display: none;">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="logo-section">
                    <h1 class="app-title">KnowledgeVault</h1>
                    <span class="app-subtitle">Preserve Knowledge Forever</span>
                </div>
                
                <nav class="main-nav">
                    <button class="nav-btn active" data-view="create">
                        <span class="nav-icon"></span>
                        Create
                    </button>
                    <button class="nav-btn" data-view="search">
                        <span class="nav-icon">=</span>
                        Search
                    </button>
                    <button class="nav-btn" data-view="explore">
                        <span class="nav-icon">=ï¿½</span>
                        Explore
                    </button>
                    <button class="nav-btn" data-view="export">
                        <span class="nav-icon">=ï¿½</span>
                        Export
                    </button>
                </nav>

                <div class="header-actions">
                    <button id="install-btn" class="install-btn" style="display: none;">
                        <span class="nav-icon"></span>
                        Install
                    </button>
                    <div class="status-indicator" id="status-indicator">
                        <span class="status-dot online"></span>
                        <span class="status-text">Online</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Create Knowledge View -->
            <section id="create-view" class="view active">
                <div class="view-header">
                    <h2>Create New Knowledge Entry</h2>
                    <p>Capture and preserve knowledge in multiple formats</p>
                </div>

                <form id="knowledge-form" class="knowledge-form">
                    <div class="form-group">
                        <label for="title">Title *</label>
                        <input type="text" id="title" name="title" required maxlength="200" 
                               placeholder="Enter a descriptive title">
                        <div class="char-counter" data-target="title">0 / 200</div>
                    </div>

                    <div class="form-group">
                        <label for="content">Content *</label>
                        <textarea id="content" name="content" required rows="8" 
                                  placeholder="Enter your knowledge content..."></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="category">Category</label>
                            <select id="category" name="category">
                                <option value="">Select category</option>
                                <option value="personal">Personal</option>
                                <option value="education">Education</option>
                                <option value="research">Research</option>
                                <option value="tutorial">Tutorial</option>
                                <option value="documentation">Documentation</option>
                                <option value="recipe">Recipe</option>
                                <option value="memory">Memory</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="language">Language</label>
                            <select id="language" name="language">
                                <option value="en">English</option>
                                <option value="es">EspaÃ±ol</option>
                                <option value="zh">ä¸­æ–‡</option>
                                <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                                <option value="hi">à¤¹à¤¿à¤‚à¤¦à¥€</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="tags">Tags</label>
                        <input type="text" id="tags" name="tags" 
                               placeholder="Enter tags separated by commas">
                        <small class="help-text">Use tags to make your knowledge easier to find</small>
                    </div>

                    <!-- Media Upload Section -->
                    <div class="media-section">
                        <h3>Attachments</h3>
                        
                        <div class="media-controls">
                            <button type="button" class="media-btn" id="add-image">
                                <span class="nav-icon">=ï¿½</span>
                                Add Image
                            </button>
                            <button type="button" class="media-btn" id="add-audio">
                                <span class="nav-icon"><ï¿½</span>
                                Record Audio
                            </button>
                            <button type="button" class="media-btn" id="add-location">
                                <span class="nav-icon">=ï¿½</span>
                                Add Location
                            </button>
                            <button type="button" class="media-btn" id="add-qr">
                                <span class="nav-icon">=ï¿½</span>
                                Generate QR
                            </button>
                        </div>

                        <div class="media-previews" id="media-previews"></div>
                    </div>

                    <!-- Location Section -->
                    <div class="location-section" id="location-section" style="display: none;">
                        <h3>Location</h3>
                        <div class="location-controls">
                            <button type="button" id="detect-location" class="btn-secondary">
                                Detect Current Location
                            </button>
                            <input type="text" id="location-search" placeholder="Search for a location...">
                        </div>
                        <div id="location-map" class="location-map"></div>
                        <div class="location-info" id="location-info"></div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-secondary" id="save-draft">
                            Save Draft
                        </button>
                        <button type="submit" class="btn-primary">
                            Save Knowledge
                        </button>
                    </div>
                </form>
            </section>

            <!-- Search View -->
            <section id="search-view" class="view">
                <div class="view-header">
                    <h2>Search Knowledge</h2>
                    <p>Find your preserved knowledge quickly</p>
                </div>

                <div class="search-container">
                    <div class="search-box">
                        <input type="text" id="search-input" placeholder="Search your knowledge...">
                        <button id="search-btn" class="search-btn">
                            <span class="nav-icon">=</span>
                        </button>
                    </div>

                    <div class="search-filters">
                        <select id="filter-category">
                            <option value="">All Categories</option>
                            <option value="personal">Personal</option>
                            <option value="education">Education</option>
                            <option value="research">Research</option>
                            <option value="tutorial">Tutorial</option>
                            <option value="documentation">Documentation</option>
                            <option value="recipe">Recipe</option>
                            <option value="memory">Memory</option>
                            <option value="other">Other</option>
                        </select>

                        <select id="filter-language">
                            <option value="">All Languages</option>
                            <option value="en">English</option>
                            <option value="es">EspaÃ±ol</option>
                            <option value="zh">ä¸­æ–‡</option>
                            <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                            <option value="hi">à¤¹à¤¿à¤‚à¤¦à¥€</option>
                        </select>

                        <input type="date" id="filter-date-from" placeholder="From date">
                        <input type="date" id="filter-date-to" placeholder="To date">
                    </div>
                </div>

                <div class="search-results" id="search-results">
                    <div class="no-results" id="no-results" style="display: none;">
                        <p>No knowledge entries found matching your search.</p>
                        <button class="btn-primary" onclick="switchView('create')">
                            Create Your First Entry
                        </button>
                    </div>
                </div>
            </section>

            <!-- Explore View -->
            <section id="explore-view" class="view">
                <div class="view-header">
                    <h2>Explore Knowledge</h2>
                    <p>Discover your knowledge geographically and chronologically</p>
                </div>

                <div class="explore-controls">
                    <div class="view-mode-switcher">
                        <button class="mode-btn active" data-mode="map">
                            <span class="nav-icon">=ï¿½</span>
                            Map View
                        </button>
                        <button class="mode-btn" data-mode="timeline">
                            <span class="nav-icon">=ï¿½</span>
                            Timeline
                        </button>
                        <button class="mode-btn" data-mode="stats">
                            <span class="nav-icon">=ï¿½</span>
                            Statistics
                        </button>
                    </div>
                </div>

                <div class="explore-content">
                    <div id="map-container" class="map-container">
                        <div id="explore-map" class="explore-map"></div>
                    </div>

                    <div id="timeline-container" class="timeline-container" style="display: none;">
                        <div class="timeline" id="knowledge-timeline"></div>
                    </div>

                    <div id="stats-container" class="stats-container" style="display: none;">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3>Total Entries</h3>
                                <div class="stat-number" id="total-entries">0</div>
                            </div>
                            <div class="stat-card">
                                <h3>Categories</h3>
                                <div class="stat-number" id="total-categories">0</div>
                            </div>
                            <div class="stat-card">
                                <h3>Languages</h3>
                                <div class="stat-number" id="total-languages">0</div>
                            </div>
                            <div class="stat-card">
                                <h3>This Month</h3>
                                <div class="stat-number" id="month-entries">0</div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="knowledge-chart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Export View -->
            <section id="export-view" class="view">
                <div class="view-header">
                    <h2>Export Knowledge</h2>
                    <p>Backup and share your knowledge in various formats</p>
                </div>

                <div class="export-options">
                    <div class="export-card">
                        <h3>JSON Export</h3>
                        <p>Complete backup of all your data</p>
                        <div class="export-actions">
                            <button class="btn-primary" id="export-json">
                                Export JSON
                            </button>
                        </div>
                    </div>

                    <div class="export-card">
                        <h3>CSV Export</h3>
                        <p>Spreadsheet-friendly format</p>
                        <div class="export-actions">
                            <button class="btn-primary" id="export-csv">
                                Export CSV
                            </button>
                        </div>
                    </div>

                    <div class="export-card">
                        <h3>HTML Export</h3>
                        <p>Static website with all your knowledge</p>
                        <div class="export-actions">
                            <button class="btn-primary" id="export-html">
                                Export HTML
                            </button>
                        </div>
                    </div>

                    <div class="export-card">
                        <h3>IPFS Storage</h3>
                        <p>Decentralized, permanent storage</p>
                        <div class="export-actions">
                            <button class="btn-primary" id="export-ipfs">
                                Store on IPFS
                            </button>
                        </div>
                    </div>

                    <div class="export-card">
                        <h3>QR Code</h3>
                        <p>Share specific entries via QR code</p>
                        <div class="export-actions">
                            <select id="qr-entry-select" class="entry-select">
                                <option value="">Select an entry...</option>
                            </select>
                            <button class="btn-primary" id="generate-qr">
                                Generate QR
                            </button>
                        </div>
                        <div id="qr-display" class="qr-display"></div>
                    </div>
                </div>

                <div class="import-section">
                    <h3>Import Knowledge</h3>
                    <div class="import-controls">
                        <input type="file" id="import-file" accept=".json" style="display: none;">
                        <button class="btn-secondary" onclick="document.getElementById('import-file').click()">
                            Import JSON File
                        </button>
                        <div id="import-status" class="import-status"></div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Knowledge Detail Modal -->
        <div id="knowledge-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modal-title"></h3>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body" id="modal-body"></div>
                <div class="modal-actions">
                    <button class="btn-secondary" id="edit-knowledge">Edit</button>
                    <button class="btn-danger" id="delete-knowledge">Delete</button>
                </div>
            </div>
        </div>

        <!-- Toast Notifications -->
        <div id="toast-container" class="toast-container"></div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Core Scripts -->
    <script src="js/core/EventBus.js"></script>
    <script src="js/core/StorageManager.js"></script>
    <script src="js/core/KnowledgeCore.js"></script>
    
    <!-- Feature Scripts -->
    <script src="js/features/AudioRecorder.js"></script>
    <script src="js/features/GeoLocator.js"></script>
    <script src="js/features/ImageProcessor.js"></script>
    <script src="js/features/SearchEngine.js"></script>
    
    <!-- UI Scripts -->
    <script src="js/ui/FormController.js"></script>
    <script src="js/ui/NavigationHandler.js"></script>
    <script src="js/ui/ViewRenderer.js"></script>
    
    <!-- Utility Scripts -->
    <script src="js/utils/DataValidator.js"></script>
    <script src="js/utils/ExportManager.js"></script>
    <script src="js/utils/TranslationBridge.js"></script>
    <script src="js/utils/PerformanceManager.js"></script>

    <!-- Initialize App -->
    <script>
        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize performance manager first
            window.performanceManager = new PerformanceManager();
            
            // Initialize EventBus
            window.eventBus = new EventBus();
            
            // Initialize core systems with optimization
            window.storageManager = new StorageManager();
            window.knowledgeCore = new KnowledgeCore();
            window.translationBridge = new TranslationBridge();
            
            // Lazy load other components
            setTimeout(() => {
                // Initialize UI components
                window.formController = new FormController();
                window.navigationHandler = new NavigationHandler();
                window.viewRenderer = new ViewRenderer();
                
                // Initialize utilities
                window.dataValidator = new DataValidator();
                window.exportManager = new ExportManager();
            }, 100);
            
            // Lazy load feature modules when needed
            const lazyLoadFeatures = () => {
                if (!window.audioRecorder) window.audioRecorder = new AudioRecorder();
                if (!window.geoLocator) window.geoLocator = new GeoLocator();
                if (!window.imageProcessor) window.imageProcessor = new ImageProcessor();
                if (!window.searchEngine) window.searchEngine = new SearchEngine();
            };
            
            // Load features on first interaction
            let featuresLoaded = false;
            document.addEventListener('click', () => {
                if (!featuresLoaded) {
                    setTimeout(lazyLoadFeatures, 0);
                    featuresLoaded = true;
                }
            }, { once: true });
            
            // Register service worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration);
                        eventBus.emit('sw:registered', registration);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            }
            
            // Handle PWA install prompt
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                window.deferredPrompt = e;
                document.getElementById('install-btn').style.display = 'block';
            });
            
            document.getElementById('install-btn').addEventListener('click', async () => {
                if (window.deferredPrompt) {
                    window.deferredPrompt.prompt();
                    const { outcome } = await window.deferredPrompt.userChoice;
                    window.deferredPrompt = null;
                    document.getElementById('install-btn').style.display = 'none';
                }
            });
            
            // Hide loading screen and show app
            setTimeout(() => {
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                eventBus.emit('app:ready');
            }, 1000);
        });
        
        // Global utility functions
        function switchView(viewName) {
            const views = document.querySelectorAll('.view');
            const navBtns = document.querySelectorAll('.nav-btn');
            
            views.forEach(view => view.classList.remove('active'));
            navBtns.forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(viewName + '-view').classList.add('active');
            document.querySelector(`[data-view="${viewName}"]`).classList.add('active');
            
            eventBus.emit('view:changed', viewName);
        }
        
        function closeModal() {
            document.getElementById('knowledge-modal').style.display = 'none';
        }
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            document.getElementById('toast-container').appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>